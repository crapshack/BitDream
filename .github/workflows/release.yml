name: Create GitHub Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build macOS app
        run: |
          xcodebuild archive \
            -project BitDream.xcodeproj \
            -scheme BitDream \
            -destination "generic/platform=macOS" \
            -archivePath build/BitDream.xcarchive \
            -configuration Release \
            CODE_SIGN_IDENTITY=- \
            MACOSX_DEPLOYMENT_TARGET=15.0 \
            ARCHS=arm64

      - name: Debug - Check app contents
        run: |
          echo "=== App bundle contents ==="
          ls -la build/BitDream.xcarchive/Products/Applications/BitDream.app/Contents/
          echo "=== Resources ==="
          ls -la build/BitDream.xcarchive/Products/Applications/BitDream.app/Contents/Resources/ || echo "No Resources folder"
          echo "=== Looking for icon files ==="
          find build/BitDream.xcarchive/Products/Applications/BitDream.app -name "*.icns" -o -name "AppIcon*" 2>/dev/null || echo "No icons found"

      - name: Create DMG
        run: |
          mkdir -p dmg-contents
          cp -R build/BitDream.xcarchive/Products/Applications/BitDream.app dmg-contents/
          hdiutil create -volname "BitDream" -srcfolder dmg-contents -ov -format UDZO "BitDream-${{ github.ref_name }}.dmg"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "${{ github.ref_name }}" \
            --generate-notes \
            BitDream-${{ github.ref_name }}.dmg
